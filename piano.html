<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>PIANO</title>
    <link rel="stylesheet" type="text/css" href="assets/css/piano.css" />
    <script src="assets/js/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="keyboard"></div>
    </div>

    <script>
      class Score {
        constructor() {
          this.score = [];
        }
        add(note, octave, length) {
          this.score.push({ note: note, octave: octave, length: length });
          return this;
        }
        /** @param {string} str */
        add_from_portal_text(str) {
          str = str.replace(/\s+/g, "");
          const get_next_node = (str) => {
            if (str === "") return;
            let note = str.slice(0, str.indexOf("("));
            str = str.slice(str.indexOf("(") + 1);
            let length = str.slice(0, str.indexOf("秒"));
            str = str.slice(str.indexOf("秒") + 2);
            this.add(note, 4, Number(length));
            get_next_node(str);
          };
          get_next_node(str);
        }
      }
      class ScoreList {
        constructor() {
          this.scores = [];
        }
        add_score(name, score) {
          this.scores.push({ name: name, score: score });
        }
        get_random_score() {
          return this.scores[Math.floor(Math.random() * this.scores.length)];
        }
      }
      class Instrument {
        /**
         * @param {number} num - 鍵盤の数
         * @param {AudioContext} audio - AudioContext
         * @param {JQuery} key_jquery - 挿入するHTMLの場所
         * @param {number} initial_octave - 最初のオクターブ
         * @param {number} shift - 鍵盤の開始位置の移動
         */
        constructor(num, audio, key_jquery, initial_octave = 0, shift = 0) {
          this.shift = shift;
          num = num + shift;

          this.audio = audio;
          this.key_jquery = key_jquery;

          this.osc_list = [];

          this.main_gain_node = this.audio.createGain();
          this.main_gain_node.connect(this.audio.destination);
          this.main_gain_node.gain.value = 1;

          const r = Math.pow(2, 1 / 12);
          this.notes = [];
          this.initial_octave = initial_octave;
          this.max_octave = Math.ceil((num - 2) / 12) + initial_octave;
          this.scale = [
            "ラ",
            "ラ#",
            "シ",
            "ド",
            "ド#",
            "レ",
            "レ#",
            "ミ",
            "ファ",
            "ファ#",
            "ソ",
            "ソ#",
          ];
          this.notes[0] = {
            freq: 27.5 * 2 ** this.initial_octave,
            note: "ラ",
            octave: this.initial_octave,
          };
          for (let i = 1; i < num; i++) {
            this.notes[i] = {
              freq: this.notes[i - 1]["freq"] * r,
              note: this.scale[i % 12],
              octave: Math.ceil((i - 2) / 12) + initial_octave,
            };
          }
          this.create_key();
        }

        create_key() {
          this.notes.splice(0, this.shift);
          this.notes.forEach((value, index) => {
            this.key_jquery.append(
              $("<div></div>")
                .data(value)
                .addClass(value.note)
                .addClass(`key`)
                .append($("<p></p>").text(value.note))
            );
          });
          this.enable_keys();
        }

        note_pressed(event) {
          if (event.buttons & 1) {
            const target = $(event.target);
            const dataset = target.data();

            if (!dataset["pressed"]) {
              this.osc_list[dataset["index"]] = this.play_tone(
                dataset["freq"],
                this.audio.currentTime,
                5
              );
              target.data("pressed", true);
              this.show_display(dataset["note"]);
            }
          }
        }

        note_released(event) {
          const target = $(event.target);
          const dataset = target.data();

          if (dataset["pressed"]) {
            if (this.osc_list[dataset["index"]]) {
              this.stop_tone(this.osc_list[dataset["index"]]);
              this.osc_list[dataset["index"]] = null;
              target.data("pressed", false);
              this.show_display();
            }
          }
        }

        stop_tone(osc_and_gain) {
          const release_time = 0.1;
          const now = this.audio.currentTime;
          osc_and_gain.gainNode.gain.cancelAndHoldAtTime(now);
          osc_and_gain.gainNode.gain.linearRampToValueAtTime(
            0,
            now + release_time
          );
          osc_and_gain.osc.stop(now + release_time + 0.1);
        }

        play_tone(freq, time, length) {
          const attack_time = 0.1;
          const release_time = 0.1;
          const osc = this.audio.createOscillator();
          osc.type = "sine";

          const gainNode = this.audio.createGain();
          gainNode.gain.setValueAtTime(0, time);
          gainNode.gain.linearRampToValueAtTime(0.5, time + attack_time);
          gainNode.gain.linearRampToValueAtTime(
            0,
            time + length + release_time
          );

          osc.connect(gainNode).connect(this.main_gain_node);
          osc.frequency.value = freq;
          osc.start(time);
          osc.stop(time + length + release_time);
          return { osc, gainNode };
        }

        /** @param {JQuery} jq */
        create_display(jq) {
          this.display = $("<div></div>").addClass(`display`);
          jq.after(this.display);
        }
        show_display(text = "") {
          this.display.text(text);
        }
        /** @param {JQuery} jq */
        create_auto_play_button(jq) {
          this.auto_play_button = $("<input>")
            .addClass(`auto_play_button`)
            .prop("type", "button")
            .prop("value", "自動演奏")
            .on("click", () => this.press_auto_play_button(this.scorelist));
          this.auto_play_text = $("<p></p>").addClass(`auto_play_text`);
          jq.before(this.auto_play_button);
          this.auto_play_button.after(this.auto_play_text);
        }

        press_auto_play_button(scorelist) {
          let score = scorelist.get_random_score().score;
          console.log(score);
          this.auto_play_button
            .prop("value", "演奏中止")
            .off()
            .on("click", () => this.stop_auto_play(score));
          this.auto_play_text.text("自動演奏中です：曲名");
          this.disable_keys();
          this.auto_play(score);
        }

        /** @param {Score} score */
        auto_play(score) {
          const schedule_ahead_time = 0.1;
          const now = this.audio.currentTime;
          let next_note_time = now;
          const play_next_node = (index) => {
            if (index >= score.score.length) {
              this.stop_auto_play();
              return;
            }
            let value = score.score[index];
            let note = this.notes.find(
              ({ note, octave }) =>
                note === value.note && octave === value.octave
            );
            if (note === undefined) {
              this.last_note = this.play_tone(0, next_note_time, value.length);
              this.show_display();
            } else {
              this.last_note = this.play_tone(
                note["freq"],
                next_note_time,
                value.length
              );
              this.show_display(note["note"]);
            }
            next_note_time += value.length;

            const wait_time =
              next_note_time - this.audio.currentTime - schedule_ahead_time;
            this.timeout_id = setTimeout(() => {
              play_next_node(index + 1);
            }, wait_time * 1000);
          };
          play_next_node(0);
        }
        stop_auto_play() {
          this.auto_play_button
            .prop("value", "自動演奏")
            .off()
            .on("click", () => this.press_auto_play_button(this.scorelist));
          this.auto_play_text.text("");
          this.show_display();
          this.enable_keys();
          this.stop_tone(this.last_note);
          clearTimeout(this.timeout_id);
        }

        enable_keys() {
          this.key_jquery
            .children(".key")
            .on("mousedown", (event) => this.note_pressed(event))
            .on("mouseup", (event) => this.note_released(event))
            .on("mouseover", (event) => this.note_pressed(event))
            .on("mouseleave", (event) => this.note_released(event));
        }
        disable_keys() {
          this.key_jquery.children(".key").off();
        }
        add_score_list(scorelist) {
          this.scorelist = scorelist;
        }
      }
    </script>
    <script>
      const audioContext = new AudioContext();
      let score = new Score();
      let scorelist = new ScoreList();
      score.add_from_portal_text(
        `ド(0.5秒)休符(0.5秒)ド(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)
ラ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ソ(2秒)
ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)
レ(0.5秒)休符(0.5秒)レ(0.5秒)休符(0.5秒)ド(2秒)

ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)
ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)レ(2秒)
ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)
ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)レ(2秒)

ド(0.5秒)休符(0.5秒)ド(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)ソ(0.5秒)休符(0.5秒)
ラ(0.5秒)休符(0.5秒)ラ(0.5秒)休符(0.5秒)ソ(2秒)
ファ(0.5秒)休符(0.5秒)ファ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)ミ(0.5秒)休符(0.5秒)
レ(0.5秒)休符(0.5秒)レ(0.5秒)休符(0.5秒)ド(4秒)`
      );
      scorelist.add_score("きらきら星", score);
      score.add_from_portal_text(
        `ド(0.5秒)レ(0.5秒)ミ(1秒)ド(0.5秒)レ(0.5秒)ミ(1秒)
ソ(0.5秒)ミ(0.5秒)レ(0.5秒)ド(0.5秒)レ(0.5秒)ミ(0.5秒)レ(1秒)
ド(0.5秒)レ(0.5秒)ミ(1秒)ド(0.5秒)レ(0.5秒)ミ(1秒)ソ(0.5秒)ミ(0.5秒)レ(0.5秒)ド(0.5秒)レ(0.5秒)ミ(0.5秒)ド(1秒)
ソ(0.25秒)休符(0.25秒)ソ(0.25秒)休符(0.25秒)ミ(0.25秒)休符(0.25秒)ソ(0.25秒)休符(0.25秒)
ラ(0.25秒)休符(0.25秒)ラ(0.25秒)休符(0.25秒)ソ(1秒)
ミ(0.25秒)休符(0.25秒)ミ(0.25秒)休符(0.25秒)レ(0.25秒)休符(0.25秒)レ(0.25秒)休符(0.25秒)ド(4秒)`
      );
      scorelist.add_score("チューリップ", score);
      let piano = new Instrument(80, audioContext, $(".keyboard"), 0, 3);
      piano.create_display($(".container"));
      piano.create_auto_play_button($(".container"));
      piano.add_score_list(scorelist);
    </script>
  </body>
</html>
